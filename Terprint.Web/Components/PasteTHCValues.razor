@page "/thcvalues/paste"
@using Microsoft.AspNetCore.Components.QuickGrid
@inject Terprint.Web.Data.TerprintWebContext DB
@inject Terprint.Web.Data.TerprintWebContext2 DB2
@inject NavigationManager NavigationManager
@using Terprint.Web.Models
<h3>Paste THC Values</h3>
<p>
    Please adhere to the format "[Analyte][ ][Dilution (1:n)][ ][LOD (%)][ ][LOQ (%)][ ][Result (mg/g)]{ ][(%)]"
</p>


<EditForm method="post" Model="@tv" OnValidSubmit="AddValues" FormName="create" Enhance>
    <div class="form-group">
        @{
            // terpeneValues = DB2.TerpeneValues.ToList();

        }
        <Terprint.Web.Components.Pages.BatchChooser></Terprint.Web.Components.Pages.BatchChooser>

        <label class="control-label">Terpene Values</label>
        <InputTextArea id="tva" @bind-Value="@tv" class="form-control" rows="10">@string.Join("\n ", DB2.THCValues.Select(t => t.Analyte).ToList())</InputTextArea>
    </div>
    <button type="submit" class="btn btn-primary">Add Values</button>
</EditForm>
@code {

    [SupplyParameterFromForm]
    public THCValue THCValue { get; set; } = new();
    [SupplyParameterFromForm]
    public IList<THCValue> THCValues { get; set; } = new List<THCValue>();
    [SupplyParameterFromForm]
    public string tv { get; set; } = new("");

    [SupplyParameterFromForm]
    public TerpeneValue TerpeneValue { get; set; } = new();

    public IList<Batch> Batches
    {
        get
        {
            batch = DB2.Batch.ToList();
            return batch;
        }
        set { batch = value; }
    }

    private IList<Batch> batch { get; set; }

    public async Task AddValues()
    {
        //Batch.Grower = Grower;
        //DB2.DisposeAsync();

        ParseValues();
        await DB.THCValues.AddRangeAsync(THCValues);
        await DB.SaveChangesAsync();
        NavigationManager.NavigateTo("/thcvalues");
    }
    private void ParseValues()
    {
        var longlist = tv;
        var result = tv.Split(new[] { '\n' });
        THCValues = new List<THCValue>();
        foreach (string s in result)
        {
            if (s.Length > 0)
            {
                string sl = s;
                int index = 0;
                if (s.Contains("Delta-9"))
                {
                    sl = s.Replace("Delta-9", "Delta-N");
                    index = sl.IndexOf(sl.FirstOrDefault(char.IsNumber));


                }
                else if (s.Contains("Delta-8"))
                {
                    sl = s.Replace("Delta-8", "Delta-E");
                    index = sl.IndexOf(sl.FirstOrDefault(char.IsNumber));

                }
                else
                {
                    index = s.IndexOf(s.FirstOrDefault(char.IsNumber));

                }
                string name = s.Substring(0, index);
                string firstnum = s.Substring(index, s.Length - index).Split(" ")[0];
                string secondnum = s.Substring(index, s.Length - index).Split(" ")[1].Replace("%", "");
                string thirddnum = s.Substring(index, s.Length - index).Split(" ")[2].Replace("%", "");
                string fourthnum = s.Substring(index, s.Length - index).Split(" ")[3].Replace("%", "");
                string fifthnum = s.Substring(index, s.Length - index).Split(" ")[4].Replace("%", "");
                THCValue THCValue = new THCValue() { Analyte = name, Dilution = firstnum, LOD = secondnum, LOQ = thirddnum, Result = fourthnum, Percent = fifthnum, BatchID = TerpeneValue.BatchID };

                THCValues.Add(new THCValue() { Analyte = name, Dilution = firstnum, LOD = secondnum, LOQ = thirddnum, Result = fourthnum, Percent = fifthnum, BatchID = TerpeneValue.BatchID });
                // THCValues.Add(new THCValue() { Name = name, Value = Convert.ToDouble(secondnum), BatchID = THCValue.BatchID });
                //THCValues.Add(new THCValue() { Name = name, Value = Convert.ToDouble(secondnum), BatchID = THCValue.BatchID });


            }
        }

    }
}
